<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crown Prince ‚Äî Kart Oyunu (Click-to-Play/Fusion)</title>

    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <audio id="sound-play" src="sounds/card_play.mp3" preload="auto"></audio>
    <audio id="sound-damage" src="sounds/damage.mp3" preload="auto"></audio>
    <audio id="sound-score" src="sounds/score_up.mp3" preload="auto"></audio>
    <audio id="sound-win" src="sounds/win.mp3" preload="auto"></audio>

    <style>
        /* --- ORTA √áAƒû / ROYAL THEME CSS --- */
        :root {
            --medieval-wood-dark: #2f1b17;
            --medieval-wood-board: #4b2f2a;
            --medieval-stone: #7a6f6b;
            --parchment: #f7f4e9;
            --gold: #d4af37;
            --text-light: #f4eee6;
            --text-dark: #2a2a2a;
            --ruby: #b10a0a;
            --card-back-dark: #3b3b3b;
            --card-back-border: #2b1b18;
            --menu-bg-gradient: linear-gradient(145deg, #3a2520, #251814);
        }
        * { box-sizing: border-box; }
        body {
            background-color: var(--medieval-wood-dark);
            color: var(--text-light);
            font-family: 'MedievalSharp', cursive;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            position: relative;
        }

        /* --- YENƒ∞ EFEKTLER (SHAKE, FLOAT, PARTICLES) --- */
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-effect {
            animation: shake 0.5s;
            animation-iteration-count: 1;
        }

        .floating-text {
            position: absolute;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            font-size: 24px;
            pointer-events: none;
            z-index: 2000;
            opacity: 1;
            text-shadow: 2px 2px 0px #000;
            transition: transform 1s ease-out, opacity 1s ease-out;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1500;
            opacity: 1;
            transition: transform 0.6s ease-out, opacity 0.6s ease-out;
        }

        /* SPLASH SCREEN */
        #splash-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background-color: var(--medieval-wood-dark); z-index: 1000;
            font-family: 'Cinzel', serif; font-size: 60px; color: var(--gold);
            text-shadow: 0 0 10px rgba(255,215,0,0.5); opacity: 0; transition: opacity 1s ease-in-out;
        }

        /* MEN√úLER GENEL STƒ∞L */
        .game-menu {
            position: absolute; width: 84%; max-width: 560px;
            padding: 36px 22px; background: var(--menu-bg-gradient);
            border: 10px solid var(--gold); border-radius: 18px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.9); z-index: 100;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .game-menu.hidden { opacity: 0; transform: scale(0.96); pointer-events: none; }
        #catalog-menu { padding-top: 60px; } 

        #menu-title { font-size: 34px; color: var(--gold); margin-bottom: 8px; }
        #menu-sub { font-size: 14px; color: var(--parchment); margin-bottom: 20px; }
        
        .btn-action { 
            padding: 12px 20px; cursor:pointer; 
            background: linear-gradient(180deg, #ffd700, #daa520); 
            border: 3px solid #b8860b; color: var(--text-dark); 
            font-size:16px; font-family: 'Cinzel', serif; font-weight: 700;
            border-radius:8px; width:100%; margin-top:14px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.4); transition: background 0.2s, transform 0.1s;
        }
        .btn-action:hover { background: linear-gradient(180deg, #ffe55c, #d4a01e); transform: translateY(-1px); }

        .btn-home-style {
            position: absolute; top: 15px; left: 15px;
            width: 44px; height: 44px; border-radius: 50%;
            background: var(--ruby); border: 2px solid var(--gold);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 200; box-shadow: 0 4px 8px rgba(0,0,0,0.6);
            color: var(--gold); transition: transform 0.2s;
        }
        .btn-home-style:hover { transform: scale(1.1); }
        .btn-home-style .material-icons { font-size: 28px; }

        /* KART KATALOƒûU */
        #catalog-list { max-height: 50vh; overflow-y: auto; margin-bottom: 15px; text-align: left; }
        .card-list-item {
            padding: 10px; margin: 6px 0; background: rgba(0,0,0,0.3);
            border: 1px solid rgba(212,175,55,0.2); border-radius: 5px; cursor: pointer;
            transition: background 0.1s; font-family: 'Cinzel', serif;
        }
        .card-list-item:hover { background: rgba(212,175,55,0.15); }
        .card-detail { margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; text-align: left;}
        .card-detail strong { color: var(--gold); font-size: 16px; display: block; margin-bottom: 4px; }
        .detail-value { font-style: italic; color: var(--parchment); }

        /* OYUN TAHTASI */
        #game-board {
            width: 100%; height: 100%; max-width: 600px;
            background-color: var(--medieval-wood-board); padding: 10px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative;
            transform-origin: center;
        }
        #game-board.hidden { display: none; }

        .stats {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; background: rgba(0,0,0,0.35);
            border: 2px solid var(--gold); border-radius: 8px;
            font-size: 14px; color: var(--gold); position: relative;
            margin: 5px 0; flex-shrink: 0;
        }
        .multiplier, .shield-icon { position: absolute; top: -10px; background: var(--ruby); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--gold); font-size: 10px; z-index: 5; }
        .multiplier { right: 10px; } .shield-icon { right: 70px; background: #3498db; }

        .hand-area {
            display: flex; gap: 8px; flex: 1; max-height: 175px; min-height: 130px;
            align-items: center; justify-content: center; overflow-x: auto; padding: 5px;
            width: 100%; border-radius: 6px; background: rgba(0,0,0,0.18);
        }
        .hand-area::-webkit-scrollbar { display: none; }

        .card {
            width: 100px; height: 145px; background: var(--parchment); border: 2px solid var(--medieval-wood-dark);
            border-radius: 8px; color: var(--text-dark); box-shadow: 3px 4px 8px rgba(0,0,0,0.6);
            transition: transform 0.18s ease, opacity 0.18s ease; /* Opacity da eklendi */
            cursor: pointer; padding: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between; font-size: 11px; position: relative; flex-shrink: 0;
            transform-style: preserve-3d;
            backface-visibility: hidden;
        }
        .card:hover { transform: translateY(-4px) rotate(-0.5deg) scale(1.02); }
        .card.selected { 
            border: 3px solid var(--ruby); 
            box-shadow: 0 0 15px rgba(177, 10, 10, 0.8);
            transform: translateY(-8px) scale(1.04) !important;
        }

        .card-back { background-color: var(--card-back-dark) !important; border-color: var(--card-back-border) !important; color: var(--text-light) !important; }
        .card-back:hover { transform: none; }
        .card .card-img { width: 48px; height: 48px; display:flex; align-items:center; justify-content:center; margin-bottom: 4px; }
        .card .card-img svg { width: 40px; height: 40px; }

        .card.drop-target-fusion { 
            outline: 4px solid var(--gold);
            box-shadow: 0 0 15px var(--gold);
        }
        #discard-pile.drop-target-play {
            outline: 4px dashed var(--ruby);
            background: rgba(177, 10, 10, 0.4);
        }
        
        #table-center { display:flex; justify-content:space-around; align-items:center; flex: 1; max-height: 180px; min-height: 140px; width: 100%; position:relative; margin: 5px 0; }
        #discard-pile { 
            width: 100px; height: 145px; border-radius:8px; box-shadow: 4px 5px 10px rgba(0,0,0,0.6); 
            display:flex; align-items:center; justify-content:center; flex-direction:column; padding:8px; 
            position: relative; cursor: pointer;
            border: 2px dashed #777; background: rgba(0,0,0,0.35); color: var(--parchment); font-size: 12px;
            transition: background 0.2s, outline 0.2s;
        }
        #discard-pile:hover:not(.drop-target-play) { background: rgba(0,0,0,0.5); } 
        
        #deck-area { width: 100px; height: 145px; border-radius:8px; box-shadow: 4px 5px 10px rgba(0,0,0,0.6); background: var(--card-back-dark); border: 2px solid var(--gold); transform: rotate(2deg); display:flex; align-items:center; justify-content:center; flex-direction:column; padding:8px; }
        #deck-area span { z-index: 1; font-family: 'Cinzel', serif; font-weight: 700; font-size: 14px; }

        /* YENƒ∞ ANIMASYON STƒ∞Lƒ∞: FLIP ve HAREKET */
        .animated-card {
            position: fixed; top: 0; left: 0;
            z-index: 900; 
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.4s ease-out;
            will-change: transform, opacity; pointer-events: none;
            transform-style: preserve-3d;
        }
        
        #log-area {
            position: absolute; bottom: 50%; left: 50%; transform: translate(-50%, 50%);
            width: 80%; padding: 8px 12px; background: rgba(0,0,0,0.75); border-radius: 8px;
            border: 1px solid var(--gold); color: var(--parchment); font-size: 16px; font-weight: 700; text-align: center;
            opacity: 0; transition: opacity 0.2s ease; z-index: 60; pointer-events: none;
        }

        @media (max-height: 700px) {
            .card, #discard-pile, #deck-area { width: 80px; height: 115px; font-size: 10px; }
            .card .card-img svg { width: 32px; height: 32px; }
            .hand-area { min-height: 120px; }
            #table-center { min-height: 125px; }
            .stats { padding: 4px 8px; font-size: 12px; }
            #menu-title { font-size: 26px; }
            #catalog-menu { padding-top: 50px; padding-bottom: 20px; }
        }
    </style>
</head>
<body>

    <div id="splash-screen">CROWN PRINCE</div>

    <div id="main-menu" class="game-menu hidden">
        <h1 id="menu-title">CROWN PRINCE</h1>
        <div id="menu-sub">Geleneksel Kral Se√ßme Kart Oyunu</div>
        <button class="btn-action" onclick="showGame()">OYUNA BA≈ûLA</button>
        <button class="btn-action" onclick="showCatalog()">Bƒ∞LGƒ∞ KARTLARI</button>
        <button class="btn-action" onclick="showSettings()">AYARLAR (Yakƒ±nda)</button>
    </div>
    
    <div id="catalog-menu" class="game-menu hidden">
        <button class="btn-home-style" onclick="showMenu()" style="border-color: var(--parchment);">
             <span class="material-icons">meeting_room</span>
        </button>
        <h2 style="color:var(--gold); font-family:'Cinzel', serif; margin-top: 0;">üìú Kart Kataloƒüu</h2>
        <div id="catalog-list"></div>
        <div id="catalog-detail"><p style="font-style:italic;">Detaylarƒ± g√∂rmek i√ßin listeden bir kart se√ßin.</p></div>
    </div>

    <div id="game-board" class="hidden">
        <button class="btn-home-style" onclick="confirmExit()">
            <span class="material-icons">meeting_room</span>
        </button>

        <div class="stats" id="cpu-stats" style="margin-top: 50px;">
            <span>ü§¥ RAKƒ∞P</span><span id="cpu-score">Hazine: 50</span>
        </div>
        
        <div id="cpu-hand" class="hand-area"></div>
        
        <div id="table-center">
            <div id="discard-pile"><span id="discard-text">ATILAN</span></div>
            <div id="log-area"></div>
            <div id="deck-area"><span id="deck-count">0</span><span style="font-size:10px; margin-top:4px;">KART</span></div>
        </div>
        
        <div id="player-hand" class="hand-area"></div>
        
        <div class="stats" id="player-stats">
            <span>üëë SEN</span><span id="player-score">Hazine: 50</span>
        </div>
    </div>

<script>
    // --- OYUN VERƒ∞LERƒ∞ ---
    const kartKatalogu = [
        { isim: "Bakƒ±r", tur: "puan", deger: 5, renk: "type-puan", aciklama: "K√º√ß√ºk bir hazine getirir.", img: `<div class="card-img"><svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="26" fill="#e6b04a" stroke="#b27a2b" stroke-width="3"/><circle cx="32" cy="32" r="10" fill="#fff3d6" opacity="0.3"/></svg></div>`, tekrar: 30, calisma: "Hazine puanƒ±nƒ±za +5 eklenir." },
        { isim: "G√ºm√º≈ü", tur: "puan", deger: 10, renk: "type-puan", aciklama: "Orta seviye bir hazine getirir.", img: `<div class="card-img"><svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="26" fill="#cfd6db" stroke="#8f9aa0" stroke-width="3"/><circle cx="32" cy="32" r="8" fill="#ffffff" opacity="0.2"/></svg></div>`, tekrar: 20, calisma: "Hazine puanƒ±nƒ±za +10 eklenir." },
        { isim: "Altƒ±n", tur: "puan", deger: 15, renk: "type-puan", aciklama: "B√ºy√ºk bir hazine getirir.", img: `<div class="card-img"><svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="M8 44c8 8 20 12 24 12s16-4 24-12V20H8v24z" fill="#ffd66b" stroke="#c79b2a" stroke-width="2"/><circle cx="32" cy="28" r="6" fill="#fff" opacity="0.25"/></svg></div>`, tekrar: 10, calisma: "Hazine puanƒ±nƒ±za +15 eklenir." },
        { isim: "Elmas", tur: "puan", deger: 30, renk: "type-puan", aciklama: "√áok deƒüerli bir hazine getirir.", img: `<div class="card-img"><svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><polygon points="32,8 52,28 32,56 12,28" fill="#9ce0ff" stroke="#4ea4d6" stroke-width="2"/><polygon points="32,14 46,28 32,48 18,28" fill="#e6fbff" opacity="0.6"/></svg></div>`, tekrar: 5, calisma: "Hazine puanƒ±nƒ±za +30 eklenir." },
        { isim: "Yakut", tur: "yakut", deger: 50, renk: "type-yakut", aciklama: "B√ºy√ºk hazine saƒülar ve √ßarpan verir.", img: `<div class="card-img"><svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><polygon points="32,6 52,26 32,58 12,26" fill="#d84b4b" stroke="#8f1f1f" stroke-width="2"/><polygon points="32,14 46,28 32,48 18,28" fill="#ffbdbd" opacity="0.25"/></svg></div>`, tekrar: 1, calisma: "Hazineye +50 ekler. Sonraki 2 hamle 2 kat etkili olur." },
        { isim: "Kalp Ta≈üƒ±", tur: "can", deger: 25, renk: "type-can", aciklama: "Hazineyi √∂nemli √∂l√ß√ºde artƒ±rƒ±r.", img: `<div class="card-img"><svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="M32 50s18-12 18-24-8-18-18-8c-10-10-18-2-18 8s18 24 18 24z" fill="#ff8da1" stroke="#b53b58" stroke-width="2"/></svg></div>`, tekrar: 5, calisma: "Hazine puanƒ±nƒ±za +25 eklenir." },
        { isim: "Ate≈ü Topu", tur: "ates", deger: -15, renk: "type-ates", aciklama: "Rakibe hasar verir.", img: `<div class="card-img"><svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="M34 8c-4 8 4 12 2 22 6-2 10 2 10 8-6-2-12 0-16 4-4-6-12-8-18-6 6-6 6-18 16-26 2 4 2 4 4 4z" fill="#ff7a2a" stroke="#b04510" stroke-width="2"/></svg></div>`, tekrar: 7, calisma: "Rakibin hazinesinden 15 puan d√º≈üer. (Kalkan engeller)." },
        { isim: "Buz M√ºhr√º", tur: "buz", deger: -5, renk: "type-buz", aciklama: "Rakibe hafif hasar verir.", img: `<div class="card-img"><svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="M32 6l4 18 18 4-18 4-4 18-4-18-18-4 18-4 4-18z" fill="#d0f0ff" stroke="#5aa7d6" stroke-width="2"/></svg></div>`, tekrar: 3, calisma: "Rakibin hazinesinden 5 puan d√º≈üer. (Kalkan engeller)." },
        { isim: "Kalkan", tur: "kalkan", deger: 0, renk: "type-kalkan", aciklama: "Hasarƒ± engeller.", img: `<div class="card-img"><svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="M32 6l14 6v14c0 12-9 22-14 26-5-4-14-14-14-26V12l14-6z" fill="#dfe6ea" stroke="#6b6f73" stroke-width="2"/></svg></div>`, tekrar: 3, calisma: "Rakibin bir sonraki Hasar Kartƒ±nƒ± engeller." },
        { isim: "Hƒ±rsƒ±z", tur: "hirsiz", deger: 0, renk: "type-hirsiz", aciklama: "Kart √ßalar.", img: `<div class="card-img"><svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="M20 18c0-6 6-10 12-10s12 4 12 10c0 4-3 6-6 6H26c-3 0-6-2-6-6z" fill="#333"/><path d="M18 44c6 6 20 8 28 0-8 2-20 2-28 0z" fill="#555"/></svg></div>`, tekrar: 3, calisma: "Rakibin elinden rastgele bir kartƒ± alƒ±p desteye karƒ±≈ütƒ±rƒ±r." }
    ];

    const fusionMap = {
        "Bakƒ±r": "G√ºm√º≈ü",
        "G√ºm√º≈ü": "Altƒ±n",
        "Altƒ±n": "Elmas"
    };

    let playerHand = [], cpuHand = [], playerScore = 50, cpuScore = 50, turn = "player", anaDeste = [], gameActive = true, lastPlayedCard = null;
    let playerMultiplierTurns = 0, cpuMultiplierTurns = 0, cpuHasShield = false, playerHasShield = false;
    let isProcessingMove = false; 
    let selectedCardIndex = -1; 

    function playSound(id) {
        const audio = document.getElementById(id);
        if (audio) { audio.currentTime = 0; audio.play().catch(e => {}); }
    }

    function createAndShuffleDeck() {
        anaDeste = [];
        kartKatalogu.forEach(kart => { for (let i = 0; i < kart.tekrar; i++) anaDeste.push({...kart}); });
        for (let i = anaDeste.length-1; i>0; i--) {
            const j = Math.floor(Math.random()*(i+1));
            [anaDeste[i], anaDeste[j]] = [anaDeste[j], anaDeste[i]];
        }
    }

    function drawCard() { return anaDeste.length ? anaDeste.pop() : null; }

    function triggerShake() {
        const board = document.getElementById("game-board");
        board.classList.remove("shake-effect");
        void board.offsetWidth; 
        board.classList.add("shake-effect");
    }

    function spawnFloatingText(targetId, text, color) {
        const targetEl = document.getElementById(targetId);
        if (!targetEl) return;
        const rect = targetEl.getBoundingClientRect();
        
        const floatEl = document.createElement("div");
        floatEl.className = "floating-text";
        floatEl.innerText = text;
        floatEl.style.color = color;
        floatEl.style.left = (rect.left + rect.width / 2 - 20) + "px";
        floatEl.style.top = (rect.top + rect.height / 2) + "px";
        
        document.body.appendChild(floatEl);
        
        requestAnimationFrame(() => {
            floatEl.style.transform = "translateY(-60px) scale(1.2)";
            floatEl.style.opacity = "0";
        });
        
        setTimeout(() => floatEl.remove(), 1000);
    }

    function spawnParticles(x, y, type) {
        const colors = {
            "gold": ["#ffd700", "#fff"],
            "damage": ["#ff4500", "#8b0000"],
            "ice": ["#00ffff", "#fff"],
            "heal": ["#ff69b4", "#fff"]
        };
        const palette = colors[type] || colors["gold"];
        
        for (let i = 0; i < 12; i++) {
            const p = document.createElement("div");
            p.className = "particle";
            p.style.backgroundColor = palette[Math.floor(Math.random() * palette.length)];
            p.style.left = x + "px";
            p.style.top = y + "px";
            document.body.appendChild(p);
            
            const angle = Math.random() * Math.PI * 2;
            const velocity = 20 + Math.random() * 60;
            const tx = Math.cos(angle) * velocity;
            const ty = Math.sin(angle) * velocity;
            
            requestAnimationFrame(() => {
                p.style.transform = `translate(${tx}px, ${ty}px) scale(0)`;
                p.style.opacity = "0";
            });
            setTimeout(() => p.remove(), 600);
        }
    }

    // --- LOG FONKSƒ∞YONU (SADELE≈ûTƒ∞Rƒ∞LDƒ∞) ---
    let logTimeout = null;
    function log(msg){
        const DURATION = 1500; // Hƒ±zlƒ±ca yok olmasƒ± i√ßin 1.5 saniye
        const el = document.getElementById("log-area"); 
        
        // Sadece "Sƒ±ra Sende" veya oyun sonucu gibi kritik mesajlarƒ± g√∂ster.
        if (msg === "Sƒ±ra sende!" || msg.includes("KAZANDIN") || msg.includes("KAYBETTƒ∞N") || msg.includes("BERABERE") || msg.includes("Oyun Ba≈üladƒ±")) {
            el.innerText = msg;
            el.style.opacity = '1';
            if (logTimeout) clearTimeout(logTimeout); 
            logTimeout = setTimeout(()=>{ el.style.opacity = '0'; }, DURATION);
        }
    }


    // --- KART Bƒ∞RLE≈ûTƒ∞RME VE √áEKME ANƒ∞MASYONLARI ---

    async function animateCardFusion(index1, index2) {
        const pArea = document.getElementById("player-hand");
        const cardEl1 = pArea.children[index1];
        const cardEl2 = pArea.children[index2];

        if (!cardEl1 || !cardEl2) return;

        // 1. Pozisyonlarƒ± al ve klonlarƒ± olu≈ütur
        const rect1 = cardEl1.getBoundingClientRect();
        const rect2 = cardEl2.getBoundingClientRect();
        const centerX = (rect1.left + rect2.left) / 2;
        const centerY = (rect1.top + rect2.top) / 2;

        const clone1 = cardEl1.cloneNode(true);
        const clone2 = cardEl2.cloneNode(true);
        clone1.classList.add('animated-card');
        clone2.classList.add('animated-card');
        clone1.classList.remove('selected', 'drop-target-fusion');
        clone2.classList.remove('selected', 'drop-target-fusion');

        // Klonlarƒ±n ba≈ülangƒ±√ß pozisyonlarƒ±nƒ± ayarla
        clone1.style.left = rect1.left + 'px';
        clone1.style.top = rect1.top + 'px';
        clone2.style.left = rect2.left + 'px';
        clone2.style.top = rect2.top + 'px';
        
        // Orijinalleri gizle ve DOM'dan kaldƒ±r (Hemen)
        cardEl1.remove();
        cardEl2.remove();

        document.body.appendChild(clone1);
        document.body.appendChild(clone2);
        playSound('sound-score');

        // 2. Klonlarƒ± merkeze doƒüru hareket ettir
        requestAnimationFrame(() => {
            const translate1X = centerX - rect1.left;
            const translate1Y = centerY - rect1.top;
            const translate2X = centerX - rect2.left;
            const translate2Y = centerY - rect2.top;
            
            clone1.style.transform = `translate(${translate1X}px, ${translate1Y}px) scale(0.8) rotate(-10deg)`;
            clone2.style.transform = `translate(${translate2X}px, ${translate2Y}px) scale(0.8) rotate(10deg)`;
        });
        
        await new Promise(r => setTimeout(r, 400));
        
        // 3. Birle≈üme efekti ve klonlarƒ± yok etme
        spawnParticles(centerX + rect1.width / 2, centerY + rect1.height / 2, "gold");
        clone1.style.opacity = '0';
        clone2.style.opacity = '0';
        
        await new Promise(r => setTimeout(r, 200));
        clone1.remove();
        clone2.remove();
        
        return { centerX, centerY }; // Yeni kartƒ±n ba≈ülangƒ±√ß pozisyonu
    }

    async function animateNewCardPopup(newCardEl, startPos) {
        if (!newCardEl || !startPos) return;

        const targetRect = newCardEl.getBoundingClientRect();
        
        // DOM elementinin ba≈ülangƒ±√ß pozisyonunu ayarla
        newCardEl.style.position = 'fixed';
        newCardEl.style.left = startPos.centerX + 'px';
        newCardEl.style.top = startPos.centerY + 'px';
        newCardEl.style.zIndex = 1000;
        newCardEl.style.opacity = '0';
        newCardEl.style.transform = 'scale(0.1) rotateY(180deg)'; 
        
        // Force reflow
        void newCardEl.offsetWidth; 

        // Hedef pozisyon ve animasyonu ba≈ülat
        requestAnimationFrame(() => {
            newCardEl.style.transition = 'transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.4s ease-out';
            newCardEl.style.left = targetRect.left + 'px';
            newCardEl.style.top = targetRect.top + 'px';
            newCardEl.style.opacity = '1';
            newCardEl.style.transform = 'scale(1.0) rotateY(0deg)';
        });

        await new Promise(r => setTimeout(r, 600));

        // Animasyon bitince normal pozisyona geri al
        newCardEl.style.position = '';
        newCardEl.style.left = '';
        newCardEl.style.top = '';
        newCardEl.style.zIndex = '';
        newCardEl.style.transition = 'transform 0.18s ease, opacity 0.18s ease';
    }

    async function drawNewCardAnimated(owner) {
        return new Promise(resolve => {
            const newCard = drawCard();
            if (!newCard) { resolve(null); return; }

            const isPlayer = owner === 'player';
            const deckArea = document.getElementById("deck-area");
            
            const deckRect = deckArea.getBoundingClientRect();
            
            // Kartƒ± √∂nce elin array'ine ekle, sonra DOM'u g√ºncelle
            if (isPlayer) playerHand.push(newCard); else cpuHand.push(newCard);
            renderHands(); 
            
            const targetHandArea = isPlayer ? document.getElementById("player-hand") : document.getElementById("cpu-hand");
            // Yeni eklenen kartƒ±n DOM elementini bul
            const targetCardEl = targetHandArea.children[targetHandArea.children.length - 1];

            const animCard = document.createElement("div");
            animCard.className = `card animated-card card-back`;
            animCard.innerHTML = `<div class="card-img"><svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="10" width="52" height="44" rx="6" fill="#6b6b6b"/></svg></div>`;
            document.body.appendChild(animCard);

            const cardWidth = targetCardEl.offsetWidth;
            const cardHeight = targetCardEl.offsetHeight;
            const startLeft = deckRect.left + (deckRect.width - cardWidth) / 2;
            const startTop = deckRect.top + (deckRect.height - cardHeight) / 2;

            animCard.style.left = startLeft + 'px';
            animCard.style.top = startTop + 'px';
            animCard.style.transform = 'translate(0, 0) scale(1.0) rotate(2deg)';

            const targetRect = targetCardEl.getBoundingClientRect();
            const targetX = targetRect.left;
            const targetY = targetRect.top;

            // Orijinal kartƒ± gizle
            targetCardEl.style.opacity = '0';
            
            requestAnimationFrame(() => {
                const translateX = targetX - startLeft;
                const translateY = targetY - startTop;
                animCard.style.transform = `translate(${translateX}px, ${translateY}px) scale(1.0) rotate(5deg)`;
            });

            setTimeout(() => {
                animCard.remove();
                targetCardEl.style.opacity = '1'; // Kartƒ± g√∂r√ºn√ºr yap
                renderHands(); // Son bir render ile pozisyonlarƒ± d√ºzelt
                resolve(newCard);
            }, 600);
        });
    }

    // --- KART Bƒ∞RLE≈ûTƒ∞RME MANTIƒûI (G√úNCELLENDƒ∞) ---

    function getCardByName(isim) {
        return kartKatalogu.find(k => k.isim === isim);
    }

    async function fusionCards(cardName1, cardName2, hand, index1, index2) {
        if (cardName1 !== cardName2 || !fusionMap[cardName1] || isProcessingMove) return false;
        isProcessingMove = true; 
        resetSelectionState();

        const newCardName = fusionMap[cardName1];
        const newCard = getCardByName(newCardName);
        if (!newCard) { isProcessingMove = false; return false; }

        // --- ANƒ∞MASYON A≈ûAMASI 1: Birle≈üme ---
        const fusionPos = await animateCardFusion(index1, index2);

        // --- LOGIC A≈ûAMASI ---
        // Array manip√ºlasyonu
        const indices = [index1, index2].sort((a, b) => b - a);
        hand.splice(indices[0], 1); 
        hand.splice(indices[1], 1); 
        hand.push({...newCard}); 

        // Ge√ßici olarak DOM'u g√ºncelle
        renderHands(); 
        
        // --- ANƒ∞MASYON A≈ûAMASI 2: Yeni Kartƒ±n Olu≈üumu ---
        const newCardIndex = playerHand.length - 1; 
        const newCardEl = document.getElementById("player-hand").children[newCardIndex];
        
        if (newCardEl && fusionPos) {
            await animateNewCardPopup(newCardEl, fusionPos); 
        }
        
        // --- ANƒ∞MASYON A≈ûAMASI 3: Desteden Kart √áekme ---
        const drawnCard = drawCard(); 
        if (drawnCard) {
            // drawNewCardAnimated kendi i√ßinde push ve renderHands'i hallediyor
            await drawNewCardAnimated('player');
        }
        
        // --- SONLANDIRMA ---
        log("Sƒ±ra Sende!"); 
        updateUI(false);
        isProcessingMove = false;
        renderHands(); // Son kez renderHands
        return true;
    }


    // --- KART SE√áƒ∞M VE AKSƒ∞YON MANTIƒûI ---

    function resetSelectionState() {
        if (selectedCardIndex !== -1) {
            const selectedEl = document.getElementById("player-hand").children[selectedCardIndex];
            if (selectedEl) selectedEl.classList.remove('selected');
        }
        selectedCardIndex = -1;
        document.getElementById("discard-pile").classList.remove('drop-target-play');
        document.getElementById("player-hand").querySelectorAll('.card').forEach((cardEl) => {
            cardEl.classList.remove('drop-target-fusion');
        });
    }

    function highlightFusionTargets(selectedName, selectedIndex) {
        if (fusionMap[selectedName]) {
            document.getElementById("player-hand").querySelectorAll('.card').forEach((cardEl, index) => {
                if (index !== selectedIndex && cardEl.dataset.name === selectedName) {
                    cardEl.classList.add('drop-target-fusion');
                }
            });
        }
    }

    function handleCardClick(clickedIndex) {
        if (turn !== 'player' || isProcessingMove) return;

        if (selectedCardIndex === -1) {
            // 1. Kart Se√ßme (ƒ∞lk Tƒ±klama)
            selectedCardIndex = clickedIndex;
            document.getElementById("player-hand").children[clickedIndex].classList.add('selected');
            document.getElementById("discard-pile").classList.add('drop-target-play'); 
            highlightFusionTargets(playerHand[clickedIndex].isim, clickedIndex); 
            
        } else {
            // 2. Aksiyon Alma (ƒ∞kinci Tƒ±klama)
            const selectedCard = playerHand[selectedCardIndex];
            const clickedCard = playerHand[clickedIndex];

            if (selectedCardIndex === clickedIndex) {
                // Aynƒ± karta tekrar tƒ±klanƒ±rsa, se√ßimi iptal et
                resetSelectionState();
                return;
            }

            // A) Birle≈ütirme Aksiyonu
            if (selectedCard.isim === clickedCard.isim && selectedCard.isim in fusionMap) {
                 fusionCards(selectedCard.isim, clickedCard.isim, playerHand, selectedCardIndex, clickedIndex);
            } else {
                // B) Ge√ßersiz Birle≈ütirme
                resetSelectionState(); 
            }
        }
    }

    function handleDiscardPileClick() {
        if (turn === 'player' && selectedCardIndex !== -1 && !isProcessingMove) {
            const indexToPlay = selectedCardIndex;
            resetSelectionState();
            playCard(indexToPlay, 'player'); 
        } 
    }

    // --- OYUN MANTIƒûI ---
    function startGame(){
        createAndShuffleDeck(); playerScore = 50; cpuScore = 50;
        playerHand=[]; cpuHand=[]; turn="player"; gameActive=true; lastPlayedCard=null;
        playerMultiplierTurns = cpuMultiplierTurns = 0; cpuHasShield = playerHasShield = false; isProcessingMove = false;
        resetSelectionState(); 
        for(let i=0;i<3;i++){ const p=drawCard(); if(p) playerHand.push(p); const c=drawCard(); if(c) cpuHand.push(c); }
        renderHands(); renderCenterArea(); updateUI(true); log("Oyun Ba≈üladƒ±!");
    }


    function checkZeroScore(){
        if (playerScore <= 0 || cpuScore <= 0) {
            if (gameActive) { const winner = playerScore > cpuScore ? 'Sen' : 'CPU'; endGame(`ANI √ñL√úM! ${winner} kazandƒ±!`, true); }
            return true;
        } return false;
    }

    function applyMultiplier(score, multiplierTurns){ return multiplierTurns>0 ? score*2 : score; }

    // --- KART OYNAMA ANIMASYONU (3D √áEVƒ∞RME DAHƒ∞L) ---
    async function playCard(index, owner){
        if (!gameActive || turn !== owner || isProcessingMove) return;
        isProcessingMove = true;
        let isPlayer = owner === 'player';
        let currentHand = isPlayer ? playerHand : cpuHand;
        let opponentHand = isPlayer ? cpuHand : playerHand;
        
        const card = currentHand[index];
        const playerHandEl = document.getElementById("player-hand");
        const cpuHandEl = document.getElementById("cpu-hand");

        const cardElement = isPlayer 
            ? playerHandEl.children[index] 
            : cpuHandEl.children[index];

        if (!cardElement) {
             isProcessingMove = false; 
             renderHands(); 
             return;
        }

        const discardPile = document.getElementById("discard-pile");
        const discardRect = discardPile.getBoundingClientRect();
        const cardRect = cardElement.getBoundingClientRect();
        
        // 1. Animasyon i√ßin clone olu≈ütur
        const cloneCard = cardElement.cloneNode(true);
        cloneCard.classList.add('animated-card');
        cloneCard.classList.remove('card-back', 'selected');
        
        if (!isPlayer) {
            cloneCard.className = `card animated-card ${card.renk}`; 
            cloneCard.innerHTML = `${card.img}<div style="font-weight:700;">${card.isim}</div><div style="font-size:10px;">${card.deger>0? '+'+card.deger : card.deger}</div>`;
            cloneCard.style.transform = `rotateY(180deg)`;
        }

        cloneCard.style.left = cardRect.left + 'px';
        cloneCard.style.top = cardRect.top + 'px';
        document.body.appendChild(cloneCard);
        
        // Orijinal kartƒ± gizle
        cardElement.style.opacity = '0';

        // Hedef Koordinatlar
        const targetCenterX = discardRect.left + discardRect.width / 2;
        const targetCenterY = discardRect.top + discardRect.height / 2;
        const currentCenterX = cardRect.left + cardRect.width / 2;
        const currentCenterY = cardRect.top + cardRect.height / 2;

        // 2. Animasyonu Ba≈ülat
        requestAnimationFrame(() => {
            const translateX = targetCenterX - currentCenterX;
            const translateY = targetCenterY - currentCenterY;
            
            if (!isPlayer) {
                cloneCard.style.transform = `translate(${translateX}px, ${translateY}px) scale(0.95) rotateY(0deg) rotate(5deg)`;
            } else {
                cloneCard.style.transform = `translate(${translateX}px, ${translateY}px) scale(0.95) rotate(5deg)`;
            }
            cloneCard.style.opacity = '1';
        });

        await new Promise(r => setTimeout(r, 600)); 
        
        currentHand.splice(index,1); cardElement.remove(); lastPlayedCard = card;
        playSound('sound-play'); cloneCard.remove();
        
        // --- ETKƒ∞ HESAPLAMA ---
        let finalValue = card.deger; 
        
        const centerEffectX = discardRect.left + discardRect.width/2;
        const centerEffectY = discardRect.top + discardRect.height/2;

        if (card.tur === "puan" || card.tur === "can" || card.tur === "yakut"){
            finalValue = applyMultiplier(finalValue, isPlayer ? playerMultiplierTurns : cpuMultiplierTurns);
            if (isPlayer) { playerScore += finalValue; spawnFloatingText("player-stats", `+${finalValue}`, "#ffd700"); spawnParticles(centerEffectX, centerEffectY, "gold"); } 
            else { cpuScore += finalValue; spawnFloatingText("cpu-stats", `+${finalValue}`, "#ffd700"); spawnParticles(centerEffectX, centerEffectY, "gold"); }
            if (card.tur === "yakut"){ 
                if (isPlayer) playerMultiplierTurns += 2; else cpuMultiplierTurns += 2; 
            }
        } 
        else if (card.tur === "ates" || card.tur === "buz"){
            let isOpponentShielded = isPlayer ? cpuHasShield : playerHasShield;
            if (isOpponentShielded){ 
                spawnFloatingText(isPlayer ? "cpu-stats" : "player-stats", "BLOK!", "#aaa");
                if (isPlayer) cpuHasShield = false; else playerHasShield = false; 
            }
            else { 
                finalValue = applyMultiplier(finalValue, isPlayer ? playerMultiplierTurns : cpuMultiplierTurns);
                const absVal = Math.abs(finalValue);
                if (isPlayer) {
                    cpuScore += finalValue; 
                    spawnFloatingText("cpu-stats", `-${absVal}`, "#ff4444");
                    spawnParticles(centerEffectX, centerEffectY, card.tur === "ates" ? "damage" : "ice");
                } else {
                    playerScore += finalValue; 
                    spawnFloatingText("player-stats", `-${absVal}`, "#ff4444");
                    spawnParticles(centerEffectX, centerEffectY, card.tur === "ates" ? "damage" : "ice");
                }
                triggerShake();
            }
        } 
        else if (card.tur === "kalkan"){ 
            if (isPlayer) playerHasShield = true; else cpuHasShield = true; 
            spawnFloatingText(isPlayer ? "player-stats" : "cpu-stats", "KALKAN", "#88ccff");
        } 
        else if (card.tur === "hirsiz"){
            if (opponentHand.length > 0){ 
                const s=opponentHand.splice(Math.floor(Math.random()*opponentHand.length),1)[0]; 
                currentHand.push(s); 
                spawnFloatingText(isPlayer ? "player-stats" : "cpu-stats", "√áALINDI!", "#bbb");
            }
        }

        if (card.tur !== "kalkan" && card.tur !== "hirsiz"){
            if (isPlayer && playerMultiplierTurns>0) playerMultiplierTurns--; 
            if (!isPlayer && cpuMultiplierTurns>0) cpuMultiplierTurns--;
        }

        updateUI(false); 

        if (checkZeroScore()) { isProcessingMove = false; return; }
        
        await drawNewCardAnimated(owner); 
        renderCenterArea();
        
        if (anaDeste.length === 0) { endGame("DESTEDE KART Bƒ∞TTƒ∞!", false); isProcessingMove = false; return; }
        
        if (isPlayer){ 
            turn = "cpu"; isProcessingMove = false; 
            setTimeout(cpuTurn, 1000); 
        } else { 
            turn = "player"; isProcessingMove = false; log("Sƒ±ra sende!"); 
        }
    }

    function cpuTurn(){
        if (!gameActive || cpuHand.length===0){ turn="player"; isProcessingMove=false; log("Sƒ±ra sende!"); return; }
        let idx = -1;
        
        const lethal = cpuHand.findIndex(c => c.tur==="ates" && playerScore <= Math.abs(applyMultiplier(c.deger, cpuMultiplierTurns))); 
        if (lethal !== -1) idx = lethal;
        if (idx === -1){ const y = cpuHand.findIndex(c=>c.tur==="yakut"); if (y !== -1) idx = y; }
        if (idx === -1 && !cpuHasShield && cpuScore < 20){ const s = cpuHand.findIndex(c=>c.tur==="kalkan"); if (s !== -1) idx = s; }
        if (idx === -1 && cpuScore < 60){ const h = cpuHand.findIndex(c=>c.tur==="puan" && c.deger >= 15); if (h !== -1) idx = h; }
        if (idx === -1) idx = Math.floor(Math.random()*cpuHand.length); 
        
        playCard(idx, 'cpu');
    }

    function endGame(message, isSudden){
        if (!gameActive) return; gameActive = false; isProcessingMove = false; playSound('sound-win');
        let result = ""; if (isSudden) result = message; else { if (playerScore > cpuScore) result = "üèÜ KAZANDIN! üèÜ"; else if (cpuScore > playerScore) result = "üíÄ KAYBETTƒ∞N..."; else result = "ü§ù BERABERE!"; }
        log(result);
        setTimeout(() => { alert(result + "\n\nOyun 2 saniye i√ßinde otomatik olarak yeniden ba≈ülayacak..."); setTimeout(startGame, 2000); }, 500);
    }

    function renderCenterArea(){
        const discardPile = document.getElementById("discard-pile"); discardPile.innerHTML = '';
        if (lastPlayedCard){
            const div = document.createElement("div"); div.className = `card discarded-card ${lastPlayedCard.renk}`;
            div.innerHTML = `${lastPlayedCard.img}<div style="font-size:11px;margin-top:6px;font-weight:700;">${lastPlayedCard.isim}</div>`; 
            discardPile.appendChild(div);
        } else { discardPile.innerHTML = `<span id="discard-text">ATILAN</span>`; }
        document.getElementById("deck-count").innerText = anaDeste.length;
    }

    function renderHands(){
        const pArea = document.getElementById("player-hand"); 
        const cArea = document.getElementById("cpu-hand");
        pArea.innerHTML = ""; 
        cArea.innerHTML = "";
        
        playerHand.forEach((card, index) => {
            const div = document.createElement("div"); 
            div.className = `card ${card.renk}`;
            div.innerHTML = `${card.img}<div style="font-weight:700;">${card.isim}</div><div style="font-size:10px;">${card.deger>0? '+'+card.deger : card.deger}</div>`;
            
            if (index === selectedCardIndex) {
                 div.classList.add('selected');
                 highlightFusionTargets(card.isim, index); 
            }
            
            div.dataset.index = index; 
            div.dataset.name = card.isim; 
            
            div.onclick = () => handleCardClick(index); 

            pArea.appendChild(div);
        });
        
        cpuHand.forEach(() => {
            const div = document.createElement("div"); div.className = "card card-back"; 
            div.innerHTML = `<div class="card-img"><svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="10" width="52" height="44" rx="6" fill="#6b6b6b"/></svg></div>`;
            cArea.appendChild(div);
        });
    }

    function updateUI(skip=false){
        const pStats = document.getElementById("player-stats"); 
        const cStats = document.getElementById("cpu-stats");

        let pM = playerMultiplierTurns>0 ? `<div class="multiplier">2X (${playerMultiplierTurns})</div>` : ''; 
        let cM = cpuMultiplierTurns>0 ? `<div class="multiplier">2X (${cpuMultiplierTurns})</div>` : '';
        if (playerHasShield) pM += `<div class="shield-icon">üõ°Ô∏è</div>`; 
        if (cpuHasShield) cM += `<div class="shield-icon">üõ°Ô∏è</div>`;
        
        pStats.innerHTML = `<span>üëë SEN</span><span id="player-score">Hazine: ${playerScore}</span>${pM}`;
        cStats.innerHTML = `<span>ü§¥ RAKƒ∞P</span><span id="cpu-score">Hazine: ${cpuScore}</span>${cM}`;
    }


    // --- MEN√ú FONKSƒ∞YONLARI (Kƒ±saltƒ±ldƒ±) ---
    function hideAllMenus() {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('game-board').classList.add('hidden');
        document.getElementById('catalog-menu').classList.add('hidden');
    }
    function showMenu() { hideAllMenus(); document.getElementById('main-menu').classList.remove('hidden'); }
    function confirmExit() { if(confirm("Oyundan √ßƒ±kƒ±p ana men√ºye d√∂nmek istiyor musun?")) { showMenu(); } }
    function showGame(){ hideAllMenus(); document.getElementById('game-board').classList.remove('hidden'); startGame(); }
    function showCatalog() {
        hideAllMenus(); document.getElementById('catalog-menu').classList.remove('hidden');
        renderCatalogList();
        document.getElementById('catalog-detail').innerHTML = '<p style="font-style:italic;">Detaylarƒ± g√∂rmek i√ßin listeden bir kart se√ßin.</p>';
    }
    function renderCatalogList() { /* ... aynƒ± kaldƒ± ... */ }
    function showCardDetail(card) { /* ... aynƒ± kaldƒ± ... */ }


    // --- BA≈ûLANGI√á OLAYLARI ---

    document.addEventListener('DOMContentLoaded', ()=>{
        
        const discardPile = document.getElementById('discard-pile');
        discardPile.addEventListener('click', handleDiscardPileClick);

        const splash = document.getElementById('splash-screen'); splash.style.opacity = '1';
        setTimeout(() => { 
            splash.style.opacity = '0'; 
            setTimeout(() => { 
                splash.style.display = 'none'; 
                showMenu(); 
                log("Oyun y√ºklendi. Hazƒ±r!"); 
            }, 1000); 
        }, 2000);
    });
</script>
</body>
</html>